@startuml RepositoryPersistDataFrameSequence

skinparam backgroundColor #FCFCFF
skinparam shadowing false
skinparam sequence {
  ArrowColor #4C6FFF
  LifeLineBorderColor #64748B
  LifeLineBackgroundColor #F8FAFC
  ParticipantBorderColor #334155
  ParticipantBackgroundColor #E2E8F0
  ActorBorderColor #1E293B
  ActorBackgroundColor #DBEAFE
  GroupBorderColor #93C5FD
  GroupBackgroundColor #EFF6FF
}

autonumber

actor Caller

participant "Repository.persist_dataframe\n(src/_pygim_fast/repository.h)" as RepoPersist
participant "MssqlStrategyNative.persist_dataframe\n(pybind lambda in mssql_strategy.cpp)" as StratPersist
participant "env_true(PYGIM_ENABLE_ARROW_BCP)" as EnvGate
participant "try_arrow_c_stream_bcp(...)" as TryCStream
participant "try_arrow_ipc_bcp(...)" as TryIpc
participant "bulk_insert_arrow_bcp(...)\n(mssql_strategy_bcp.cpp)" as BulkArrow
participant "run_bulk_upsert(...)" as RunFallback
participant "bulk_upsert(...)" as BulkUpsert
participant "to_py_dict(...)" as ToDict

Caller -> RepoPersist: persist_dataframe(table, data_frame, key_column, prefer_arrow, table_hint, batch_size)

loop for each strategy in m_strategies
  RepoPersist -> RepoPersist: if hasattr(strat, "persist_dataframe")
  RepoPersist -> StratPersist: strat.persist_dataframe(...)

  alt prefer_arrow == true
    StratPersist -> EnvGate: env_true("PYGIM_ENABLE_ARROW_BCP")

    alt env gate disabled
      StratPersist -> StratPersist: arrow_error = "disabled by default..."
      StratPersist -> RunFallback: run_bulk_upsert(...)
      RunFallback -> BulkUpsert: self.bulk_upsert(...)
      BulkUpsert --> RunFallback: success/failure
      RunFallback --> StratPersist: PersistAttempt(mode=bulk_upsert)
      StratPersist -> ToDict: to_py_dict(fallback, arrow_error)
      ToDict --> RepoPersist: dict(mode=bulk_upsert, arrow_error=...)

    else env gate enabled
      StratPersist -[#red]> TryCStream: try_arrow_c_stream_bcp(...)
      note over StratPersist, TryCStream #FFCDD2
        BOTTLENECK A:
        c-stream often fails in this environment,
        adding failed-attempt overhead before fallback.
      end note
      TryCStream -> TryCStream: data_frame.__arrow_c_stream__() or to_arrow(...)
      TryCStream -[#red]> BulkArrow: bulk_insert_arrow_bcp(c_stream_capsule,...)
      note over TryCStream, BulkArrow #FFCDD2
        BOTTLENECK B:
        hot BCP path is ODBC-call heavy.
      end note

      alt c-stream success
        BulkArrow --> TryCStream: success
        TryCStream --> StratPersist: PersistAttempt(success=true, mode=arrow_c_stream_bcp)
        StratPersist -> ToDict: to_py_dict(c_stream_attempt, none)
        ToDict --> RepoPersist: dict(mode=arrow_c_stream_bcp)

      else c-stream failed
        BulkArrow --> TryCStream: throw/py error
        TryCStream --> StratPersist: PersistAttempt(success=false, error=...)

        StratPersist -[#red]> TryIpc: try_arrow_ipc_bcp(...)
        TryIpc -[#red]> TryIpc: data_frame.write_ipc(file=None, compat_level=oldest)
        note over TryIpc #FFCDD2
          BOTTLENECK C:
          IPC serialization/materialization cost
          before BCP write.
        end note
        TryIpc -[#red]> BulkArrow: bulk_insert_arrow_bcp(ipc_payload,...)

        alt ipc success
          BulkArrow --> TryIpc: success
          TryIpc --> StratPersist: PersistAttempt(success=true, mode=arrow_ipc_bcp)
          StratPersist -> ToDict: to_py_dict(ipc_attempt, c_stream_error?)
          ToDict --> RepoPersist: dict(mode=arrow_ipc_bcp)

        else ipc failed
          BulkArrow --> TryIpc: throw/py error
          TryIpc --> StratPersist: PersistAttempt(success=false, error=...)
          StratPersist -> StratPersist: combined_error = c_stream_error | ipc_error
          StratPersist -> RunFallback: run_bulk_upsert(...)
          RunFallback -> BulkUpsert: self.bulk_upsert(...)
          BulkUpsert --> RunFallback: success/failure
          RunFallback --> StratPersist: PersistAttempt(mode=bulk_upsert)
          StratPersist -> ToDict: to_py_dict(fallback, combined_error)
          ToDict --> RepoPersist: dict(mode=bulk_upsert, arrow_error=combined_error)
        end
      end
    end

  else prefer_arrow == false
    StratPersist -[#red]> RunFallback: run_bulk_upsert(...)
    RunFallback -[#red]> BulkUpsert: self.bulk_upsert(...)
    note over RunFallback, BulkUpsert #FFCDD2
      BOTTLENECK D:
      fallback path is typically slower than Arrow BCP.
    end note
    BulkUpsert --> RunFallback: success/failure
    RunFallback --> StratPersist: PersistAttempt(mode=bulk_upsert)
    StratPersist -> ToDict: to_py_dict(fallback, none)
    ToDict --> RepoPersist: dict(mode=bulk_upsert)
  end

  RepoPersist --> Caller: persist_stats dict
end

@enduml